<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <title>Analytics Dashboard - FraudHive</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='assets/icons/favicon_icon.png') }}">
    <style>
        /* Back Button */
        .back-button {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 999;
            padding: 0.75rem 1.5rem;
            background: rgba(74, 158, 255, 0.9);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(43, 125, 224, 0.95);
            transform: translateX(-5px);
            box-shadow: 0 6px 16px rgba(74, 158, 255, 0.5);
        }
    </style>
</head>
<body>
    <!-- Back Button -->
    <button class="back-button" onclick="window.history.back()">
        <i class="bi bi-arrow-left"></i> Back
    </button>

    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <span class="logo-icon">
                    <img src="{{ url_for('static', filename='assets/icons/monitoring-health-svgrepo-com.svg') }}" alt="FraudGuard" class="icon-primary">
                </span>
                <span class="logo-text">FraudHive</span>
                <span class="logo-subtext">Powered by Nokia NaC</span>
                <!-- <span class="logo-badge">Powered by Nokia NaC</span> -->
            </div>
           <div class="nav-links">
                <a href="/" class="nav-link">
                    <i class="bi bi-shield-check"></i> Analyze Transaction
                </a>
                <a href="/logs" class="nav-link">
                    <i class="bi bi-list-ul"></i> Transaction History
                </a>
                <a href="/dashboard" class="nav-link active">
                    <i class="bi bi-graph-up"></i> Dashboard
                </a>
                <a href="/analytics" class="nav-link">
                    <i class="bi bi-graph-up-arrow"></i> Analytics
                </a>
            </div>
        </div>
    </nav>

    <div class="dashboard-page">
        <div class="page-header">
            <h1><i class="bi bi-graph-up"></i> Analytics Dashboard</h1>
            <p>Comprehensive fraud detection analytics and insights</p>
        </div>

        <!-- KPI Cards -->
            <div class="kpi-section">
                <div class="kpi-card">
                    <div class="kpi-icon"><i class="bi bi-activity"></i></div>
                    <div class="kpi-content">
                        <div class="kpi-value">{{ stats.total_transactions }}</div>
                        <div class="kpi-label">Total Transactions</div>
                    </div>
                </div>
                
                <div class="kpi-card kpi-danger">
                    <div class="kpi-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    <div class="kpi-content">
                        <div class="kpi-value">{{ stats.high_risk_count }}</div>
                        <div class="kpi-label">High Risk Detected</div>
                    </div>
                </div>
                
                <div class="kpi-card kpi-warning">
                    <div class="kpi-icon"><i class="bi bi-sim"></i></div>
                    <div class="kpi-content">
                        <div class="kpi-value">{{ stats.sim_swap_detections }}</div>
                        <div class="kpi-label">SIM Swaps</div>
                    </div>
                </div>
                
                <div class="kpi-card kpi-info">
                    <div class="kpi-icon"><i class="bi bi-geo-alt"></i></div>
                    <div class="kpi-content">
                        <div class="kpi-value">{{ stats.location_mismatches }}</div>
                        <div class="kpi-label">Location Mismatches</div>
                    </div>
                </div>
                
                <div class="kpi-card kpi-warning">
                    <div class="kpi-icon"><i class="bi bi-globe"></i></div>
                    <div class="kpi-content">
                        <div class="kpi-value">{{ stats.roaming_detections }}</div>
                        <div class="kpi-label">Roaming Detected</div>
                    </div>
                </div>
                
                <div class="kpi-card kpi-danger">
                    <div class="kpi-icon"><i class="bi bi-phone-vibrate"></i></div>
                    <div class="kpi-content">
                        <div class="kpi-value">{{ stats.device_not_connected }}</div>
                        <div class="kpi-label">Devices Offline</div>
                    </div>
                </div>
            </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <h3><i class="bi bi-clock-history"></i> Transaction Volume (24h)</h3>
                <canvas id="volumeChart"></canvas>
            </div>
            
            <div class="chart-card">
                <h3><i class="bi bi-pie-chart"></i> Risk Distribution</h3>
                <canvas id="riskDistChart"></canvas>
            </div>
            
            <div class="chart-card full-width">
                <h3><i class="bi bi-graph-up-arrow"></i> Fraud Trend (7 Days)</h3>
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Top Risky Numbers Table -->
        <div class="risky-numbers-section">
            <h3><i class="bi bi-exclamation-circle"></i> High Risk Phone Numbers</h3>
            {% if analytics.top_risky_numbers %}
            <table class="risky-table">
                <thead>
                    <tr>
                        <th>Phone Number</th>
                        <th>Risk Score</th>
                        <th>Transactions</th>
                        <th>Total Amount</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for phone in analytics.top_risky_numbers %}
                    <tr>
                        <td><code>{{ phone.number }}</code></td>
                        <td>
                            <div class="risk-score-bar">
                                <div class="risk-score-fill" style="width: {{ phone.risk_score }}%; background: {% if phone.risk_score > 70 %}#ef4444{% elif phone.risk_score > 35 %}#f59e0b{% else %}#10b981{% endif %};"></div>
                                <span class="risk-score-text">{{ phone.risk_score }}%</span>
                            </div>
                        </td>
                        <td>{{ phone.transaction_count }}</td>
                        <td>${{ phone.total_amount }}</td>
                        <td>
                            <button class="btn-investigate" onclick="window.location.href='/investigation/{{ phone.number }}'">
                                <i class="bi bi-search"></i> Investigate
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <p>No transaction data available yet</p>
            </div>
            {% endif %}
        </div>

        <!-- Geographic Distribution -->
        <div class="geo-section">
            <h3><i class="bi bi-globe"></i> Geographic Distribution</h3>
            {% if analytics.geographic_distribution %}
            <table class="geo-table">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th>Transactions</th>
                        <th>High Risk</th>
                        <th>Risk Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for geo in analytics.geographic_distribution %}
                    <tr>
                        <td><strong>{{ geo.country }}</strong></td>
                        <td>{{ geo.transaction_count }}</td>
                        <td>{{ geo.high_risk_count }}</td>
                        <td>
                            <span class="risk-badge {% if geo.risk_rate > 50 %}high-risk{% elif geo.risk_rate > 20 %}medium-risk{% else %}low-risk{% endif %}">
                                {{ geo.risk_rate }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <p>No geographic data available yet</p>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Transaction Volume Chart (24h)
        const volumeCtx = document.getElementById('volumeChart').getContext('2d');
        const hourlyData = {{ analytics.hourly_transactions | tojson }};
        
        new Chart(volumeCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(hourlyData).map(h => h + ':00'),
                datasets: [{
                    label: 'Transactions',
                    data: Object.values(hourlyData),
                    backgroundColor: 'rgba(74, 158, 255, 0.6)',
                    borderColor: 'rgba(74, 158, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });

        // Risk Distribution Pie Chart
        const riskDistCtx = document.getElementById('riskDistChart').getContext('2d');
        const riskData = {{ analytics.risk_distribution | tojson }};
        
        new Chart(riskDistCtx, {
            type: 'doughnut',
            data: {
                labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                datasets: [{
                    data: [riskData['High Risk'], riskData['Medium Risk'], riskData['Low Risk']],
                    backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Fraud Trend Line Chart
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        const trendData = {{ analytics.fraud_trend | tojson }};
        const dates = Object.keys(trendData);
        
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Fraud Rate (%)',
                    data: dates.map(d => trendData[d].fraud_rate),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Total Transactions',
                    data: dates.map(d => trendData[d].total_txns),
                    borderColor: '#4a9eff',
                    backgroundColor: 'rgba(74, 158, 255, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Fraud Rate (%)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Total Transactions'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>