<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='assets/icons/favicon_icon.png') }}">
    <title>Transaction History - FraudHive</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Back Button */
        .back-button {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 999;
            padding: 0.75rem 1.5rem;
            background: rgba(74, 158, 255, 0.9);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(43, 125, 224, 0.95);
            transform: translateX(-5px);
            box-shadow: 0 6px 16px rgba(74, 158, 255, 0.5);
        }

        /* Collapsible Section Styles */
        .collapsible-section {
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible-header {
            background: linear-gradient(135deg, rgba(74, 158, 255, 0.1), rgba(16, 185, 129, 0.1));
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            user-select: none;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(74, 158, 255, 0.15), rgba(16, 185, 129, 0.15));
        }

        .collapsible-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .collapsible-toggle {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
            color: var(--primary-color);
        }

        .collapsible-toggle.expanded {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease;
            padding: 0 1.5rem;
        }

        .collapsible-content.expanded {
            max-height: 2000px;
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        /* Score Breakdown Styles */
        .score-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .score-card {
            background: var(--bg-dark);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid;
            transition: transform 0.2s ease;
        }

        .score-card:hover {
            transform: translateY(-2px);
        }

        .score-card.ml-score {
            border-color: #3b82f6;
        }

        .score-card.weighted-score {
            border-color: #8b5cf6;
        }

        .score-card.condition-score {
            border-color: #f59e0b;
        }

        .score-card.final-score {
            border-color: #ef4444;
        }

        .score-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .score-value {
            font-size: 2rem;
            font-weight: 800;
            line-height: 1;
        }

        .score-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* Score Progress Bars */
        .score-progress {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .score-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        .ml-score .score-progress-fill {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
        }

        .weighted-score .score-progress-fill {
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
        }

        .condition-score .score-progress-fill {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .final-score .score-progress-fill {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        /* Pagination Controls */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            border-radius: 0 0 12px 12px;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .pagination-btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .page-numbers {
            display: flex;
            gap: 0.5rem;
        }

        .page-number {
            padding: 0.5rem 0.75rem;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-number:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-number.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: 600;
        }

        /* Row Animation */
        @keyframes fadeInRow {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .logs-table tbody tr {
            animation: fadeInRow 0.3s ease-out;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }

        .loading-spinner-large {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(74, 158, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Back Button -->
    <button class="back-button" onclick="window.history.back()">
        <i class="bi bi-arrow-left"></i> Back
    </button>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner-large"></div>
            <p style="color: var(--text-primary); margin: 0;">Loading transactions...</p>
        </div>
    </div>

    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <span class="logo-icon">
                    <img src="{{ url_for('static', filename='assets/icons/monitoring-health-svgrepo-com.svg') }}" alt="FraudGuard" class="icon-primary">
                </span>
                <span class="logo-text">FraudHive</span>
                <span class="logo-subtext">Powered by Nokia NaC</span>
                <!-- <span class="logo-badge">Powered by Nokia NaC</span> -->
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">
                    <i class="bi bi-shield-check"></i> Analyze Transaction
                </a>
                <a href="/logs" class="nav-link active">
                    <i class="bi bi-list-ul"></i> Transaction History
                </a>
                <a href="/dashboard" class="nav-link">
                    <i class="bi bi-graph-up"></i> Dashboard
                </a>
                <a href="/analytics" class="nav-link">
                    <i class="bi bi-graph-up-arrow"></i> Analytics
                </a>
            </div>
        </div>
    </nav>

    <div class="logs-page">
        <div class="page-header">
            <h1><i class="bi bi-journal-text"></i> Complete Transaction History</h1>
            <p>Comprehensive audit trail with ML scores, network intelligence, and rule-based assessments</p>
        </div>

        <div class="stats-summary">
            <div class="summary-card">
                <div class="summary-label">Total Transactions</div>
                <div class="summary-value">{{ stats.total_transactions }}</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">High Risk</div>
                <div class="summary-value text-danger">{{ stats.high_risk_count }}</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">SIM Swaps</div>
                <div class="summary-value text-warning">{{ stats.sim_swap_detections }}</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Location Mismatches</div>
                <div class="summary-value text-warning">{{ stats.location_mismatches }}</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Roaming Detected</div>
                <div class="summary-value text-warning">{{ stats.roaming_detections }}</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Devices Offline</div>
                <div class="summary-value text-danger">{{ stats.device_not_connected }}</div>
            </div>
        </div>

        <div class="filters-section">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç Search phone number..." onkeyup="applyFilters()">
            <select id="riskFilter" class="filter-select" onchange="applyFilters()">
                <option value="all">All Risk Levels</option>
                <option value="High Risk">High Risk</option>
                <option value="Medium Risk">Medium Risk</option>
                <option value="Low Risk">Low Risk</option>
            </select>
        </div>

        <div class="logs-table-container">
            {% if logs %}
            <table class="logs-table" id="logsTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Phone Number</th>
                        <th>Amount</th>
                        <th>Merchant Name</th>
                        <th>Payment Channel</th>
                        <th>Final Risk Score</th>
                        <th>Risk Level</th>
                        <th>Network Checks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>

            <!-- Pagination Controls -->
            <div class="pagination-container">
                <div class="pagination-info" id="paginationInfo">
                    Showing 0 - 0 of 0 transactions
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prevBtn" onclick="previousPage()">
                        <i class="bi bi-chevron-left"></i> Previous
                    </button>
                    <div class="page-numbers" id="pageNumbers">
                        <!-- Page numbers will be populated by JavaScript -->
                    </div>
                    <button class="pagination-btn" id="nextBtn" onclick="nextPage()">
                        Next <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üìä</div>
                <h3>No Transactions Yet</h3>
                <p>Start analyzing transactions to build your audit trail</p>
                <a href="/" class="btn-primary"><i class="bi bi-plus-circle"></i> Analyze Transaction</a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Enhanced Details Modal with Collapsible Sections -->
    <div id="detailsModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2><i class="bi bi-file-text"></i> Comprehensive Transaction Report</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Store all logs data
        const allLogs = {{ logs | tojson | safe }};
        let filteredLogs = [...allLogs];
        let currentPage = 1;
        const rowsPerPage = 10;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            applyFilters();
        });

        // Apply search and filter
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedRisk = document.getElementById('riskFilter').value;
            
            filteredLogs = allLogs.filter(log => {
                const matchesSearch = log.phone_number.toLowerCase().includes(searchTerm);
                const matchesRisk = selectedRisk === 'all' || log.risk_level === selectedRisk;
                return matchesSearch && matchesRisk;
            });
            
            currentPage = 1;
            renderTable();
        }

        // Render table with pagination
        function renderTable() {
            const tbody = document.getElementById('logsTableBody');
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageData = filteredLogs.slice(startIndex, endIndex);
            
            tbody.innerHTML = '';
            
            pageData.forEach(log => {
                const row = createTableRow(log);
                tbody.appendChild(row);
            });
            
            updatePaginationControls();
            animateProbabilityBars();
        }

        // Create table row
        function createTableRow(log) {
            const tr = document.createElement('tr');
            tr.setAttribute('data-risk', log.risk_level);
            
            // Use final_score if available, fallback to fraud_probability
            const finalScore = log.final_score !== undefined ? log.final_score : (log.fraud_probability * 100);
            
            tr.innerHTML = `
                <td>${log.timestamp}</td>
                <td><code>${log.phone_number}</code></td>
                <td>$${parseFloat(log.transaction_amount).toFixed(2)}</td>
                <td>${log.merchant_name || 'N/A'}</td>
                <td>${log.payment_method || 'N/A'}</td>
                <td>
                    <div class="probability-bar">
                        <div class="probability-fill" style="width: ${finalScore}%"></div>
                        <span class="probability-text">${finalScore.toFixed(1)}%</span>
                    </div>
                </td>
                <td>
                    <span class="risk-badge ${log.risk_level.toLowerCase().replace(' ', '-')}">
                        ${log.risk_level}
                    </span>
                </td>
                <td>
                    <div class="network-checks">
                        ${log.camara_data.sim_swap.swapped ? '<span class="check-badge check-alert" title="SIM Swap Detected"><i class="bi bi-sim"></i> SWAP</span>' : ''}
                        ${!log.camara_data.location.verified ? '<span class="check-badge check-alert" title="Location Mismatch"><i class="bi bi-geo-alt"></i> LOC</span>' : ''}
                        ${log.camara_data.roaming.roaming ? '<span class="check-badge check-alert" title="Device Roaming"><i class="bi bi-globe"></i> ROAM</span>' : ''}
                        ${log.camara_data.device_status.connection_status === 'NOT_CONNECTED' ? '<span class="check-badge check-alert" title="Device Offline"><i class="bi bi-phone-x"></i> OFF</span>' : ''}
                        ${log.camara_data.device_status.connection_status === 'SMS' ? '<span class="check-badge check-warning" title="SMS Only"><i class="bi bi-chat-dots"></i> SMS</span>' : ''}
                        ${log.camara_data.device_status.connection_status === 'DATA' ? '<span class="check-badge check-safe" title="Data Connected"><i class="bi bi-wifi"></i> DATA</span>' : ''}
                        ${!log.camara_data.sim_swap.swapped && log.camara_data.location.verified && !log.camara_data.roaming.roaming && log.camara_data.device_status.connection_status === 'DATA' ? '<span class="check-badge check-safe" title="All Checks Passed"><i class="bi bi-check-circle"></i> OK</span>' : ''}
                    </div>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-details" onclick='showDetails(${JSON.stringify(log).replace(/'/g, "\\'")})'
>
                            <i class="bi bi-eye"></i> Details
                        </button>
                        <button class="btn-investigate" onclick="window.location.href='/investigation/${log.phone_number}'">
                            <i class="bi bi-search"></i> Investigate
                        </button>
                    </div>
                </td>
            `;
            
            return tr;
        }

        // Update pagination controls (keeping existing pagination code)
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredLogs.length / rowsPerPage);
            const startIndex = (currentPage - 1) * rowsPerPage + 1;
            const endIndex = Math.min(currentPage * rowsPerPage, filteredLogs.length);
            
            document.getElementById('paginationInfo').textContent = 
                `Showing ${startIndex} - ${endIndex} of ${filteredLogs.length} transactions`;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
            
            renderPageNumbers(totalPages);
        }

        function renderPageNumbers(totalPages) {
            const pageNumbersContainer = document.getElementById('pageNumbers');
            pageNumbersContainer.innerHTML = '';
            
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) {
                    pageNumbersContainer.appendChild(createPageNumber(i));
                }
            } else {
                pageNumbersContainer.appendChild(createPageNumber(1));
                
                if (currentPage > 3) {
                    pageNumbersContainer.appendChild(createEllipsis());
                }
                
                for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                    pageNumbersContainer.appendChild(createPageNumber(i));
                }
                
                if (currentPage < totalPages - 2) {
                    pageNumbersContainer.appendChild(createEllipsis());
                }
                
                pageNumbersContainer.appendChild(createPageNumber(totalPages));
            }
        }

        function createPageNumber(pageNum) {
            const btn = document.createElement('div');
            btn.className = 'page-number' + (pageNum === currentPage ? ' active' : '');
            btn.textContent = pageNum;
            btn.onclick = () => goToPage(pageNum);
            return btn;
        }

        function createEllipsis() {
            const span = document.createElement('span');
            span.textContent = '...';
            span.style.padding = '0.5rem';
            span.style.color = 'var(--text-secondary)';
            return span;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
                scrollToTop();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredLogs.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
                scrollToTop();
            }
        }

        function goToPage(pageNum) {
            currentPage = pageNum;
            renderTable();
            scrollToTop();
        }

        function scrollToTop() {
            document.querySelector('.logs-table-container').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        function animateProbabilityBars() {
            setTimeout(() => {
                document.querySelectorAll('.probability-fill').forEach(fill => {
                    const width = fill.style.width;
                    fill.style.width = '0';
                    setTimeout(() => {
                        fill.style.width = width;
                    }, 100);
                });
            }, 100);
        }

        // ENHANCED: Show details modal with collapsible sections and multiple scores
        function showDetails(log) {
            const modalBody = document.getElementById('modalBody');
            
            // Extract scores (with fallback for old logs)
            const mlScore = log.model_score !== undefined ? log.model_score : (log.fraud_probability * 100);
            const weightedScore = log.weighted_score !== undefined ? log.weighted_score : mlScore;
            const conditionScore = log.condition_score !== undefined ? log.condition_score : 0;
            const finalScore = log.final_score !== undefined ? log.final_score : (log.fraud_probability * 100);

            modalBody.innerHTML = `
                <!-- Score Breakdown Section (Always Expanded) -->
                <div class="modal-section" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border: 2px solid #3b82f6; border-radius: 12px; padding: 1.5rem;">
                    <h3 style="color: #3b82f6; margin-top: 0;"><i class="bi bi-speedometer2"></i> Score Breakdown</h3>
                    <div class="score-breakdown">
                        <div class="score-card ml-score">
                            <div class="score-label">ML Base Score</div>
                            <div class="score-value" style="color: #3b82f6;">${mlScore.toFixed(1)}%</div>
                            <div class="score-progress">
                                <div class="score-progress-fill" style="width: ${mlScore}%"></div>
                            </div>
                            <div class="score-description">XGBoost model prediction</div>
                        </div>
                        
                        <div class="score-card weighted-score">
                            <div class="score-label">Weighted Score</div>
                            <div class="score-value" style="color: #8b5cf6;">${weightedScore.toFixed(1)}%</div>
                            <div class="score-progress">
                                <div class="score-progress-fill" style="width: ${weightedScore}%"></div>
                            </div>
                            <div class="score-description">ML + CAMARA features</div>
                        </div>
                        
                        <div class="score-card condition-score">
                            <div class="score-label">Rule Engine Score</div>
                            <div class="score-value" style="color: #f59e0b;">${conditionScore.toFixed(1)}%</div>
                            <div class="score-progress">
                                <div class="score-progress-fill" style="width: ${conditionScore}%"></div>
                            </div>
                            <div class="score-description">Triggered conditions</div>
                        </div>
                        
                        <div class="score-card final-score">
                            <div class="score-label">Final Risk Score</div>
                            <div class="score-value" style="color: #ef4444;">${finalScore.toFixed(1)}%</div>
                            <div class="score-progress">
                                <div class="score-progress-fill" style="width: ${finalScore}%"></div>
                            </div>
                            <div class="score-description">Decision: <strong>${log.risk_level}</strong></div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Information (Collapsible) -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h3><i class="bi bi-cash-coin"></i> Transaction Information</h3>
                        <i class="bi bi-chevron-down collapsible-toggle"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Phone Number:</span>
                                <span class="info-value">${log.phone_number}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Amount:</span>
                                <span class="info-value">$${parseFloat(log.transaction_amount).toFixed(2)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Timestamp:</span>
                                <span class="info-value">${log.timestamp}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Risk Level:</span>
                                <span class="info-value">
                                    <span class="risk-badge ${log.risk_level.toLowerCase().replace(' ', '-')}">${log.risk_level}</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Profile (Collapsible) -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h3><i class="bi bi-person-badge-fill"></i> Customer Profile</h3>
                        <i class="bi bi-chevron-down collapsible-toggle"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="info-grid">
                            <div class="info-item"><span class="info-label">Customer Vintage:</span><span class="info-value">${log.customer_vintage || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Risk Rating:</span><span class="info-value">${log.risk_rating || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Customer Segment:</span><span class="info-value">${log.segment || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Occupation:</span><span class="info-value">${log.occupation || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">KYC Country:</span><span class="info-value">${log.kyc_country || log.country || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">KYC City:</span><span class="info-value">${log.kyc_city || log.city || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Geo Restriction Level:</span><span class="info-value">${log.geo_restriction || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">PEP / High Risk Flag:</span><span class="info-value">${log.pep_flag || 'N/A'}</span></div>
                        </div>
                    </div>
                </div>

                <!-- Network Intelligence (Collapsible) -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h3><i class="bi bi-broadcast"></i> Network Intelligence (CAMARA APIs)</h3>
                        <i class="bi bi-chevron-down collapsible-toggle"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="info-grid">
                            <div class="info-item"><span class="info-label">SIM Swap:</span><span class="info-value">${log.camara_data.sim_swap.swapped ? '<span class="badge-danger">‚ö†Ô∏è DETECTED</span>' : '<span class="badge-success">‚úÖ Clear</span>'}</span></div>
                            <div class="info-item"><span class="info-label">Last Swap Date:</span><span class="info-value">${log.camara_data.sim_swap.last_swap_date}</span></div>
                            <div class="info-item"><span class="info-label">Location Verified:</span><span class="info-value">${log.camara_data.location.verified ? '<span class="badge-success">‚úÖ Verified</span>' : '<span class="badge-danger">‚ö†Ô∏è Mismatch</span>'}</span></div>
                            <div class="info-item"><span class="info-label">Distance from KYC:</span><span class="info-value">${(log.camara_data.location.distance_meters / 1000).toFixed(1)} km</span></div>
                            <div class="info-item"><span class="info-label">Current Location:</span><span class="info-value">${log.current_city || 'N/A'}, ${log.current_country || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Roaming:</span><span class="info-value">${log.camara_data.roaming.roaming ? '<span class="badge-danger">üåê ROAMING</span>' : '<span class="badge-success">üè† HOME</span>'}</span></div>
                            <div class="info-item"><span class="info-label">Current Network:</span><span class="info-value">${log.camara_data.roaming.current_network}</span></div>
                            <div class="info-item"><span class="info-label">Device Connection:</span><span class="info-value">${log.camara_data.device_status.connection_status}</span></div>
                            <div class="info-item"><span class="info-label">Signal Strength:</span><span class="info-value">${log.camara_data.device_status.signal_strength}</span></div>
                            <div class="info-item"><span class="info-label">Network Type:</span><span class="info-value">${log.camara_data.device_status.network_type}</span></div>
                        </div>
                    </div>
                </div>

                <!-- Triggered Rules (Collapsible) -->
                ${log.explanation && log.explanation.triggered_rules && log.explanation.triggered_rules.length > 0 ? `
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h3><i class="bi bi-exclamation-triangle"></i> Triggered Rules (${log.explanation.triggered_rules.length})</h3>
                        <i class="bi bi-chevron-down collapsible-toggle"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="rules-list-modal">
                            ${log.explanation.triggered_rules.map(rule => `
                                <div class="modal-rule-item severity-${rule.severity}">
                                    <div class="modal-rule-header">
                                        <span class="modal-rule-name">${rule.rule}</span>
                                        <span class="modal-rule-severity">${rule.severity}</span>
                                    </div>
                                    <div class="modal-rule-description">
                                        <strong>Impact:</strong> ${rule.impact} | ${rule.description}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Analysis Summary (Collapsible) -->
                ${log.explanation && log.explanation.summary ? `
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h3><i class="bi bi-chat-left-text"></i> Analysis Summary</h3>
                        <i class="bi bi-chevron-down collapsible-toggle"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="explanation-box">
                            <p>${log.explanation.summary}</p>
                            ${log.explanation.factors && log.explanation.factors.length > 0 ? `
                                <strong style="display: block; margin-top: 1rem;">Key Factors:</strong>
                                <ul>${log.explanation.factors.map(f => `<li>${f}</li>`).join('')}</ul>
                            ` : ''}
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Transaction Patterns (Collapsible) -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <h3><i class="bi bi-graph-up"></i> Transaction Patterns</h3>
                        <i class="bi bi-chevron-down collapsible-toggle"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="info-grid">
                            <div class="info-item"><span class="info-label">Transactions (1 Hour):</span><span class="info-value">${log.txn_count_1h || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Credit Reversals (7 Days):</span><span class="info-value">${log.credit_reversals_7d || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Avg Monthly Transaction:</span><span class="info-value">${parseFloat(log.avg_monthly_txn || 0).toFixed(2)}</span></div>
                            <div class="info-item"><span class="info-label">Transaction Frequency:</span><span class="info-value">${parseFloat(log.txn_frequency || 0).toFixed(2)}x mean</span></div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('detailsModal').style.display = 'flex';
            
            // Animate score progress bars
            setTimeout(() => {
                document.querySelectorAll('.score-progress-fill').forEach(fill => {
                    const width = fill.style.width;
                    fill.style.width = '0';
                    setTimeout(() => {
                        fill.style.width = width;
                    }, 100);
                });
            }, 200);
        }

        // Toggle collapsible section
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.collapsible-toggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }

        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailsModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>